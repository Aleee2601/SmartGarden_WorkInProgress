<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:viewmodel="clr-namespace:SmartGarden.App.ViewModels"
             xmlns:model="clr-namespace:SmartGarden.Core.Models;assembly=SmartGarden.Core"
             x:Class="SmartGarden.App.Views.PlantsPage"
             x:DataType="viewmodel:PlantsViewModel"
             Title="{Binding Title}">

    <ContentPage.ToolbarItems>
        <ToolbarItem Text="Add"
                     Command="{Binding AddPlantCommand}"
                     IconImageSource="plus.png"/>
        <ToolbarItem Text="Logout"
                     Command="{Binding LogoutCommand}"/>
    </ContentPage.ToolbarItems>

    <Grid RowDefinitions="Auto,*">

        <!-- Header -->
        <VerticalStackLayout Grid.Row="0" Padding="20,10" BackgroundColor="{StaticResource Primary}">
            <Label Text="ðŸŒ± My Smart Garden"
                   FontSize="24"
                   FontAttributes="Bold"
                   TextColor="White"/>
        </VerticalStackLayout>

        <!-- Plants List -->
        <RefreshView Grid.Row="1"
                     IsRefreshing="{Binding IsBusy}"
                     Command="{Binding RefreshPlantsCommand}">

            <CollectionView ItemsSource="{Binding Plants}"
                           SelectionMode="Single"
                           SelectedItem="{Binding SelectedPlant}"
                           SelectionChangedCommand="{Binding PlantSelectedCommand}"
                           SelectionChangedCommandParameter="{Binding SelectedPlant}">

                <CollectionView.EmptyView>
                    <VerticalStackLayout VerticalOptions="Center" HorizontalOptions="Center" Padding="20">
                        <Label Text="ðŸŒ±"
                               FontSize="60"
                               HorizontalOptions="Center"/>
                        <Label Text="No plants yet"
                               FontSize="20"
                               FontAttributes="Bold"
                               HorizontalOptions="Center"
                               Margin="0,10,0,5"/>
                        <Label Text="Tap the + button to add your first plant"
                               FontSize="14"
                               TextColor="{StaticResource Gray600}"
                               HorizontalOptions="Center"/>
                    </VerticalStackLayout>
                </CollectionView.EmptyView>

                <CollectionView.ItemTemplate>
                    <DataTemplate x:DataType="model:Plant">
                        <Border Margin="15,10"
                               Padding="15"
                               Background="White"
                               Stroke="{StaticResource Gray200}"
                               StrokeThickness="1"
                               StrokeShape="RoundRectangle 10">

                            <Border.Shadow>
                                <Shadow Brush="Black" Opacity="0.1" Offset="0,2" Radius="10"/>
                            </Border.Shadow>

                            <Grid RowDefinitions="Auto,Auto,Auto" ColumnDefinitions="*,Auto">

                                <!-- Plant Name -->
                                <Label Grid.Row="0" Grid.Column="0"
                                       Text="{Binding Nickname}"
                                       FontSize="18"
                                       FontAttributes="Bold"
                                       TextColor="{StaticResource Gray900}"/>

                                <!-- Room/Location -->
                                <Label Grid.Row="1" Grid.Column="0"
                                       Text="{Binding RoomName}"
                                       FontSize="14"
                                       TextColor="{StaticResource Gray600}"
                                       Margin="0,5,0,10"/>

                                <!-- Soil Moisture -->
                                <HorizontalStackLayout Grid.Row="2" Grid.Column="0" Spacing="20">
                                    <VerticalStackLayout Spacing="3">
                                        <Label Text="ðŸ’§ Moisture"
                                               FontSize="12"
                                               TextColor="{StaticResource Gray600}"/>
                                        <Label Text="{Binding LastSoilMoisture, StringFormat='{0:F1}%'}"
                                               FontSize="16"
                                               FontAttributes="Bold"
                                               TextColor="{StaticResource Primary}"/>
                                    </VerticalStackLayout>

                                    <VerticalStackLayout Spacing="3">
                                        <Label Text="ðŸŒ¡ï¸ Temperature"
                                               FontSize="12"
                                               TextColor="{StaticResource Gray600}"/>
                                        <Label Text="{Binding LastAirTemp, StringFormat='{0:F1}Â°C'}"
                                               FontSize="16"
                                               FontAttributes="Bold"
                                               TextColor="{StaticResource Primary}"/>
                                    </VerticalStackLayout>
                                </HorizontalStackLayout>

                                <!-- Water Button -->
                                <Button Grid.Row="0" Grid.RowSpan="3" Grid.Column="1"
                                       Text="ðŸ’§ Water"
                                       Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodel:PlantsViewModel}}, Path=WaterPlantCommand}"
                                       CommandParameter="{Binding .}"
                                       BackgroundColor="{StaticResource Primary}"
                                       TextColor="White"
                                       WidthRequest="80"
                                       HeightRequest="80"
                                       CornerRadius="40"
                                       VerticalOptions="Center"/>

                            </Grid>
                        </Border>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>

        </RefreshView>

    </Grid>

</ContentPage>
